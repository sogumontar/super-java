-- MPM On-Us

SET antspark.app.runningQueueName=root.public
;


SELECT *
  FROM (SELECT ext.NMID
              ,RIGHT(ext.MPAN,9)        AS subMPAN
              ,COALESCE(ext.SHOP_ID, base.merchant_id) as MERCHANT_OR_SHOP_ID
          FROM (SELECT merchant_id
                      ,acquirement_id
                  FROM dana_dw.ods_aqc_base
                 WHERE dt = '{yyyymmdd-1}'
                   AND merchant_id <> '216620000020928274717'
                   AND merchant_id = '216620000005515427026'
                   AND product_code IN ( '51051000100000000040' , '51051000101000100040' , '51051000100000000051' , '51051000101000100051'
                                       , '51051000100000000048' , '51051000101000100048' )
                   AND buyer_user_id NOT IN ( '216610000000000100003' , '216610000000000001012' , '216610000000000002022' , '216610000000000003032'
                                            , '216610000000000004042' , '216610000000000005052' , '216610000000000006062' , '216610000000000007072'
                                            , '216610000000000008082' , '216610000000000009092' , '216610000000000010102' , '216610000000000011112'
                                            , '216610000000000012122' , '216610000000000013132' , '216610000000000014142' , '216610000000000015152'
                                            , '216610000000000016162' , '216610000000000017172' , '216610000000000018182' , '216610000000000019192'
                                            , '216610000000000020202' , '216610000000000021212' , '216610000000000022222' , '216610000000000023232'
                                            , '216610000000000024242' , '216610000000000025252' , '216610000000000026262' , '216610000000000027272'
                                            , '216610000000000028282' , '216610000000000029292' , '216610000000000030302' , '216610000000000031312'
                                            , '216610000000000032322' , '216610000000000033332' , '216610000000000034342' , '216610000000000035352'
                                            , '216610000000000036362' , '216610000000000037372' , '216610000000000038382' , '216610000000000039392'
                                            , '216610000000000040402' , '216610000000000041412' , '216610000000000042422' , '216610000000000043432'
                                            , '216610000000000044442' , '216610000000000045452' , '216610000000000046462' , '216610000000000047472'
                                            , '216610000000000048482' , '216610000000000049492' , '216610000000000050502' , '216610000000000051512'
                                            , '216610000000000052522' , '216610000000000053532' , '216610000000000054542' , '216610000000000055552'
                                            , '216610000000000056562' , '216610000000000057572' , '216610000000000058582' , '216610000000000059592'
                                            , '216610000000000060602' , '216610000000000061612' , '216610000000000062622' , '216610000000000063632'
                                            , '216610000000000064642' , '216610000000000065652' , '216610000000000066662' , '216610000000000067672'
                                            , '216610000000000068682' , '216610000000000069692' , '216610000000000070702' , '216610000000000071712'
                                            , '216610000000000072722' , '216610000000000073732' , '216610000000000074742' , '216610000000000075752'
                                            , '216610000000000076762' , '216610000000000077772' , '216610000000000078782' , '216610000000000079792'
                                            , '216610000000000080802' , '216610000000000081812' , '216610000000000082822' , '216610000000000083832'
                                            , '216610000000000084842' , '216610000000000085852' , '216610000000000086862' , '216610000000000087872'
                                            , '216610000000000088882' , '216610000000000089892' , '216610000000000090902' , '216610000000000091912'
                                            , '216610000000000092922' , '216610000000000093932' , '216610000000000094942' , '216610000000000095952'
                                            , '216610000000000096962' , '216610000000000097972' , '216610000000000098982' , '216610000000000099992' )
                   AND order_status = 'SUCCESS'
               )base
          JOIN (SELECT get_json_object(ext_data ,'$.gpnMerchantId') AS NMID
                      ,get_json_object(ext_data ,'$.merchantPan')   AS MPAN
                      ,get_json_object(ext_data ,'$.shopId')        AS SHOP_ID
                      ,acquirement_id
                  FROM dana_dw.ods_aqc_ext
                 WHERE dt = '{yyyymmdd-1}'
                   AND (ext_type = 'EMVCO_CODE_INFO'
                     OR ext_type = 'EMVCO_ISSUER_INFO'
                     OR ext_type = 'SHOP_INFO')
               )ext
            ON base.acquirement_id = ext.acquirement_id
       )t1
  JOIN (SELECT ip_role_id
              ,ri_id
          FROM dana_dw.ods_cu_rel_role_site_acc
         WHERE dt = '{yyyymmdd-1}'
           AND rel_biz_type = 'EXTERNAL_MERCHANT_ID'
       )t2
    ON t1.MERCHANT_OR_SHOP_ID = t2.ip_role_id
  JOIN (SELECT inner_id
              ,ri_id
          FROM dana_dw.ods_cu_ri_site_acc
         WHERE dt = '{yyyymmdd-1}'
           AND site_name = 'GPN'
           AND tnt_inst_id = 'DANAW3ID'
       )t3
    ON t3.ri_id = t2.ri_id
  JOIN (SELECT role_id
              ,role_code
          FROM dana_dw.ods_cu_role_code
         WHERE dt = '{yyyymmdd-1}'
           AND tnt_inst_id = 'DANAW3ID'
           AND code_biz_type = '1'
       )t4
    ON t1.MERCHANT_OR_SHOP_ID = t2.ip_role_id
 WHERE t1.NMID <> t3.inner_id
     OR t4.role_code NOT LIKE t1.subMPAN




-- MPM Acquirer Off-Us

SET antspark.app.runningQueueName=root.public
;


SELECT *
  FROM (SELECT ext.NMID
              ,RIGHT(ext.MPAN,9)        AS subMPAN
              ,COALESCE(ext.SHOP_ID, base.merchant_id) as MERCHANT_OR_SHOP_ID
          FROM (SELECT merchant_id
                      ,acquirement_id
                  FROM dana_dw.ods_aqc_base
                 WHERE dt = '{yyyymmdd-1}'
                   AND merchant_id <> '216620000020928274717'
                   AND product_code IN ( '51051000100000000051' , '51051000101000100051', '51051000100000000048' , '51051000101000100048' )
                   AND buyer_user_id IN ( '216610000000000100003' , '216610000000000001012' , '216610000000000002022' , '216610000000000003032'
                                        , '216610000000000004042' , '216610000000000005052' , '216610000000000006062' , '216610000000000007072'
                                        , '216610000000000008082' , '216610000000000009092' , '216610000000000010102' , '216610000000000011112'
                                        , '216610000000000012122' , '216610000000000013132' , '216610000000000014142' , '216610000000000015152'
                                        , '216610000000000016162' , '216610000000000017172' , '216610000000000018182' , '216610000000000019192'
                                        , '216610000000000020202' , '216610000000000021212' , '216610000000000022222' , '216610000000000023232'
                                        , '216610000000000024242' , '216610000000000025252' , '216610000000000026262' , '216610000000000027272'
                                        , '216610000000000028282' , '216610000000000029292' , '216610000000000030302' , '216610000000000031312'
                                        , '216610000000000032322' , '216610000000000033332' , '216610000000000034342' , '216610000000000035352'
                                        , '216610000000000036362' , '216610000000000037372' , '216610000000000038382' , '216610000000000039392'
                                        , '216610000000000040402' , '216610000000000041412' , '216610000000000042422' , '216610000000000043432'
                                        , '216610000000000044442' , '216610000000000045452' , '216610000000000046462' , '216610000000000047472'
                                        , '216610000000000048482' , '216610000000000049492' , '216610000000000050502' , '216610000000000051512'
                                        , '216610000000000052522' , '216610000000000053532' , '216610000000000054542' , '216610000000000055552'
                                        , '216610000000000056562' , '216610000000000057572' , '216610000000000058582' , '216610000000000059592'
                                        , '216610000000000060602' , '216610000000000061612' , '216610000000000062622' , '216610000000000063632'
                                        , '216610000000000064642' , '216610000000000065652' , '216610000000000066662' , '216610000000000067672'
                                        , '216610000000000068682' , '216610000000000069692' , '216610000000000070702' , '216610000000000071712'
                                        , '216610000000000072722' , '216610000000000073732' , '216610000000000074742' , '216610000000000075752'
                                        , '216610000000000076762' , '216610000000000077772' , '216610000000000078782' , '216610000000000079792'
                                        , '216610000000000080802' , '216610000000000081812' , '216610000000000082822' , '216610000000000083832'
                                        , '216610000000000084842' , '216610000000000085852' , '216610000000000086862' , '216610000000000087872'
                                        , '216610000000000088882' , '216610000000000089892' , '216610000000000090902' , '216610000000000091912'
                                        , '216610000000000092922' , '216610000000000093932' , '216610000000000094942' , '216610000000000095952'
                                        , '216610000000000096962' , '216610000000000097972' , '216610000000000098982' , '216610000000000099992' )
                   AND order_status = 'SUCCESS'
               )base
          JOIN (SELECT get_json_object(ext_data ,'$.gpnMerchantId') AS NMID
                      ,get_json_object(ext_data ,'$.merchantPan')   AS MPAN
                      ,get_json_object(ext_data ,'$.shopId')        AS SHOP_ID
                      ,acquirement_id
                  FROM dana_dw.ods_aqc_ext
                 WHERE dt = '{yyyymmdd-1}'
                   AND (ext_type = 'EMVCO_CODE_INFO'
                     OR ext_type = 'EMVCO_ISSUER_INFO'
                     OR ext_type = 'SHOP_INFO')
               )ext
            ON base.acquirement_id = ext.acquirement_id
       )t1
  JOIN (SELECT ip_role_id
              ,ri_id
          FROM dana_dw.ods_cu_rel_role_site_acc
         WHERE dt = '{yyyymmdd-1}'
           AND rel_biz_type = 'EXTERNAL_MERCHANT_ID'
       )t2
    ON t1.MERCHANT_OR_SHOP_ID = t2.ip_role_id
  JOIN (SELECT inner_id
              ,ri_id
          FROM dana_dw.ods_cu_ri_site_acc
         WHERE dt = '{yyyymmdd-1}'
           AND site_name = 'GPN'
           AND tnt_inst_id = 'DANAW3ID'
       )t3
    ON t3.ri_id = t2.ri_id
  JOIN (SELECT role_id
              ,role_code
          FROM dana_dw.ods_cu_role_code
         WHERE dt = '{yyyymmdd-1}'
           AND tnt_inst_id = 'DANAW3ID'
           AND code_biz_type = '1'
       )t4
    ON t1.MERCHANT_OR_SHOP_ID = t2.ip_role_id
 WHERE t1.NMID <> t3.inner_id
     OR t4.role_code NOT LIKE t1.subMPAN
